name: BMS DailyBO 1‚Äì9 + Combine (Code ‚Üí Data Repo)

on:
  workflow_dispatch:
  schedule:
    - cron: "5 * * * *"

permissions:
  contents: read

jobs:
# =====================================================
# 1Ô∏è‚É£ SHARDS (SCRAPE ONLY ‚Äî NO LOCAL SAVE)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    steps:
      - name: üßæ Checkout DailyBoxOffice (code only)
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: üì¶ Install dependencies
        run: |
          pip install cloudscraper aiohttp pytz

      - name: üöÄ Run shard scraper (local temp data)
        run: |
          python bmsdaily${{ matrix.shard }}.py

      - name: üì§ Push shard data to BoxOfficeData
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo

          rsync -av daily/ data-repo/daily/
          rsync -av advance/ data-repo/advance/ || true

          cd data-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add daily advance
          git commit -m "Shard ${{ matrix.shard }} update ($(date -u +'%Y-%m-%d %H:%M UTC'))" || exit 0
          git pull --rebase origin main || true
          git push origin main

# =====================================================
# 2Ô∏è‚É£ COMBINE (FINAL AUTHORITY)
# =====================================================
  combine:
    name: Combine all shards (Final ‚Üí Data Repo)
    needs: shards
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: bms-combiner
      cancel-in-progress: false

    steps:
      - name: üßæ Checkout DailyBoxOffice (code only)
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: üîÅ Combine & push final data
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          pip install pytz
          python combine_dailyshards.py

          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo

          rsync -av daily/ data-repo/daily/
          rsync -av advance/ data-repo/advance/ || true

          cd data-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add daily advance
          git commit -m "Final combined BO data ($(date -u +'%Y-%m-%d %H:%M UTC'))" || exit 0
          git pull --rebase origin main || true
          git push origin main
