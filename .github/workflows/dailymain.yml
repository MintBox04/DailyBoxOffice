name: BMS DailyBO

on:
  workflow_dispatch:
  schedule:
    - cron: "5 * * * *"

permissions:
  contents: read

jobs:
# =====================================================
# 1ï¸âƒ£ SHARDS (PARALLEL SCRAPERS â†’ DATA REPO)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    steps:
      - name: ğŸ§¾ Checkout DailyBoxOffice (code only)
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install cloudscraper aiohttp pytz

      - name: ğŸš€ Run shard scraper
        run: |
          python bmsdaily${{ matrix.shard }}.py

      - name: ğŸ“¤ Push shard data to BoxOfficeData (FIXED)
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          set -e

          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo
          cd data-repo

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MAX_TRIES=5
          TRY=1

          while [ $TRY -le $MAX_TRIES ]; do
            echo "ğŸ” Shard push attempt $TRY / $MAX_TRIES"

            # ğŸ”‘ RESET FIRST (IMPORTANT)
            git fetch origin main
            git reset --hard origin/main

            # ğŸ”‘ ENSURE DIR EXISTS
            mkdir -p daily/data

            # ğŸ”‘ COPY FILES AFTER RESET
            rsync -av ../daily/data/ daily/data/

            if [ -d ../advance ]; then
              rsync -av ../advance/ advance/
            fi

            git add daily/data advance
            git commit -m "Shard ${{ matrix.shard }} update ($(date -u +'%Y-%m-%d %H:%M UTC'))" || true

            if git push origin main; then
              echo "âœ… Shard push successful"
              exit 0
            fi

            TRY=$((TRY+1))
            sleep 3
          done

          echo "âŒ Shard push failed after retries"
          exit 1

# =====================================================
# 2ï¸âƒ£ COMBINE (FINAL AUTHORITY â†’ DATA REPO)
# =====================================================
  combine:
    name: Combine all shards (FINAL)
    needs: shards
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: bms-combiner
      cancel-in-progress: false

    steps:
      - name: ğŸ§¾ Checkout DailyBoxOffice (code only)
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: ğŸ” Combine & push final data (FIXED)
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          set -e

          pip install pytz
          python combine_dailyshards.py

          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo
          cd data-repo

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MAX_TRIES=6
          TRY=1

          while [ $TRY -le $MAX_TRIES ]; do
            echo "ğŸ” Combine push attempt $TRY / $MAX_TRIES"

            # ğŸ”‘ RESET FIRST
            git fetch origin main
            git reset --hard origin/main

            mkdir -p daily/data

            # ğŸ”‘ COPY FILES AFTER RESET
            rsync -av ../daily/data/ daily/data/

            if [ -d ../advance ]; then
              rsync -av ../advance/ advance/
            fi

            git add daily/data advance
            git commit -m "Final combined BO data ($(date -u +'%Y-%m-%d %H:%M UTC'))" || true

            if git push origin main; then
              echo "âœ… Final push successful"
              exit 0
            fi

            TRY=$((TRY+1))
            sleep 5
          done

          echo "âŒ Combine failed after retries"
          exit 1
