name: BMS DailyBO

on:
  workflow_dispatch:
  schedule:
    - cron: "5 * * * *"

permissions:
  contents: read

jobs:
# =====================================================
# 1Ô∏è‚É£ SHARDS (PARALLEL ‚Üí DATA REPO)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    steps:
      - name: üßæ Checkout DailyBoxOffice (code repo)
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: üì¶ Install dependencies
        run: |
          pip install cloudscraper aiohttp pytz

      - name: üöÄ Run shard scraper
        run: |
          python bmsdaily${{ matrix.shard }}.py

      - name: üì§ Push shard data (Daily + Advance)
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          set -e

          # ---------- clone data repo ----------
          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo
          cd data-repo

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MAX_TRIES=5
          TRY=1

          while [ $TRY -le $MAX_TRIES ]; do
            echo "üîÅ Shard push attempt $TRY / $MAX_TRIES"

            # ---------- ALWAYS RESET FIRST ----------
            git fetch origin main
            git reset --hard origin/main

            # ---------- ENSURE SOURCE EXISTS (CODE REPO) ----------
            mkdir -p ../daily/data
            mkdir -p ../advance

            # ---------- ENSURE DEST EXISTS (DATA REPO) ----------
            mkdir -p daily/data
            mkdir -p advance

            # ---------- COPY DAILY ----------
            rsync -av ../daily/data/ daily/data/

            # ---------- COPY ADVANCE (ONLY IF EXISTS) ----------
            if [ "$(ls -A ../advance 2>/dev/null)" ]; then
              rsync -av ../advance/ advance/
            fi

            git add daily/data advance
            git commit -m "Shard ${{ matrix.shard }} update ($(date -u +'%Y-%m-%d %H:%M UTC'))" || true

            if git push origin main; then
              echo "‚úÖ Shard push successful"
              exit 0
            fi

            TRY=$((TRY+1))
            sleep 3
          done

          echo "‚ùå Shard push failed after retries"
          exit 1

# =====================================================
# 2Ô∏è‚É£ COMBINE (FINAL AUTHORITY)
# =====================================================
  combine:
    name: Combine all shards (FINAL)
    needs: shards
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: bms-combiner
      cancel-in-progress: false

    steps:
      - name: üßæ Checkout DailyBoxOffice (code repo)
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: üîÅ Combine & push final data
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          set -e

          pip install pytz
          python combine_dailyshards.py

          # ---------- clone data repo ----------
          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo
          cd data-repo

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MAX_TRIES=6
          TRY=1

          while [ $TRY -le $MAX_TRIES ]; do
            echo "üîÅ Combine push attempt $TRY / $MAX_TRIES"

            # ---------- RESET FIRST ----------
            git fetch origin main
            git reset --hard origin/main

            # ---------- ENSURE SOURCE EXISTS ----------
            mkdir -p ../daily/data
            mkdir -p ../advance

            # ---------- ENSURE DEST EXISTS ----------
            mkdir -p daily/data
            mkdir -p advance

            # ---------- COPY DAILY ----------
            rsync -av ../daily/data/ daily/data/

            # ---------- COPY ADVANCE ----------
            if [ "$(ls -A ../advance 2>/dev/null)" ]; then
              rsync -av ../advance/ advance/
            fi

            git add daily/data advance
            git commit -m "Final combined BO data ($(date -u +'%Y-%m-%d %H:%M UTC'))" || true

            if git push origin main; then
              echo "‚úÖ Final push successful"
              exit 0
            fi

            TRY=$((TRY+1))
            sleep 5
          done

          echo "‚ùå Combine failed after retries"
          exit 1
