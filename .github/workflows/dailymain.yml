name: BMS DailyBO

on:
  workflow_dispatch:
  schedule:
    - cron: "5 * * * *"

permissions:
  contents: read

jobs:
# =====================================================
# 1Ô∏è‚É£ SHARDS (PARALLEL SCRAPERS ‚Üí DATA REPO)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    steps:
      - name: üßæ Checkout DailyBoxOffice (code only)
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: üì¶ Install dependencies
        run: |
          pip install cloudscraper aiohttp pytz

      - name: üöÄ Run shard scraper
        run: |
          python bmsdaily${{ matrix.shard }}.py

      - name: üì§ Push shard data to BoxOfficeData (SAFE)
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          set -e

          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo

          # üîë ENSURE SOURCE DIR EXISTS (CRITICAL FIX)
          mkdir -p daily/data

          # Sync daily shard data
          rsync -av daily/data/ data-repo/daily/data/

          # Sync advance data only if exists
          if [ -d advance ]; then
            rsync -av advance/ data-repo/advance/
          fi

          cd data-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MAX_TRIES=5
          TRY=1

          while [ $TRY -le $MAX_TRIES ]; do
            echo "üîÅ Shard push attempt $TRY / $MAX_TRIES"

            git fetch origin main
            git reset --hard origin/main

            git add daily/data advance
            git commit -m "Shard ${{ matrix.shard }} update ($(date -u +'%Y-%m-%d %H:%M UTC'))" || true

            if git push origin main; then
              echo "‚úÖ Shard push successful"
              exit 0
            fi

            TRY=$((TRY+1))
            sleep 3
          done

          echo "‚ùå Shard push failed after retries"
          exit 1

# =====================================================
# 2Ô∏è‚É£ COMBINE (FINAL AUTHORITY ‚Üí DATA REPO)
# =====================================================
  combine:
    name: Combine all shards (FINAL)
    needs: shards
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: bms-combiner
      cancel-in-progress: false

    steps:
      - name: üßæ Checkout DailyBoxOffice (code only)
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.1"

      - name: üîÅ Combine & push final data
        env:
          DATA_REPO_TOKEN: ${{ secrets.BOXOFFICE_DATA_TOKEN }}
        run: |
          set -e

          pip install pytz
          python combine_dailyshards.py

          git clone https://x-access-token:${DATA_REPO_TOKEN}@github.com/MintBox04/BoxOfficeData.git data-repo

          # üîë ENSURE SOURCE DIR EXISTS (CRITICAL FIX)
          mkdir -p daily/data

          # Sync combined daily data
          rsync -av daily/data/ data-repo/daily/data/

          # Sync advance data only if exists
          if [ -d advance ]; then
            rsync -av advance/ data-repo/advance/
          fi

          cd data-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MAX_TRIES=6
          TRY=1

          while [ $TRY -le $MAX_TRIES ]; do
            echo "üîÅ Combine push attempt $TRY / $MAX_TRIES"

            git fetch origin main
            git reset --hard origin/main

            git add daily/data advance
            git commit -m "Final combined BO data ($(date -u +'%Y-%m-%d %H:%M UTC'))" || true

            if git push origin main; then
              echo "‚úÖ Final push successful"
              exit 0
            fi

            TRY=$((TRY+1))
            sleep 5
          done

          echo "‚ùå Combine failed after retries"
          exit 1
